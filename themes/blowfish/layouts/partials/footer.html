<footer id="site-footer" class="py-10 print:hidden">
  {{/* Footer menu */}}
  {{ if .Site.Params.footer.showMenu | default true }}
    {{ if .Site.Menus.footer }}
      {{ $onlyIcon := true }}
      {{ range .Site.Menus.footer }}
        {{ if .Name }}
          {{ $onlyIcon = false }}
          {{ break }}
        {{ end }}
      {{ end }}
      {{ $navClass := printf "flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400 %s" (cond $onlyIcon "overflow-x-auto py-2" "") }}
      {{ $ulClass := printf "flex list-none %s" (cond $onlyIcon "flex-row" "flex-col sm:flex-row") }}
      {{ $liClass := printf "flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0 %s" (cond $onlyIcon "me-4" "") }}
      <nav class="{{ $navClass }}">
        <ul class="{{ $ulClass }}">
          {{ range .Site.Menus.footer }}
            <li class=" {{ $liClass }}">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center"
                href="{{ .URL }}"
                title="{{ .Title }}">
                {{ if .Pre }}
                  <span {{ if and .Pre .Name }}class="mr-1"{{ end }}>
                    {{ partial "icon.html" .Pre }}
                  </span>
                {{ end }}
                {{ .Name | markdownify }}
              </a>
            </li>
          {{ end }}
        </ul>
      </nav>
    {{ end }}
  {{ end }}
  <div class="flex items-center justify-between">
    {{/* Copyright */}}
    {{ if .Site.Params.footer.showCopyright | default true }}
      <p class="text-sm text-neutral-500 dark:text-neutral-400">
        {{- with replace .Site.Params.copyright "{ year }" now.Year }}
          {{ . | markdownify }}
        {{- else }}
          &copy;
          {{ now.Format "2006" }}
          {{ .Site.Params.Author.name | markdownify }}
        {{- end }}
      </p>
    {{ end }}

    {{/* Theme attribution */}}
    {{ if .Site.Params.footer.showThemeAttribution | default true }}
      <p class="text-xs text-neutral-500 dark:text-neutral-400">
        {{ $hugo := printf `<a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
          href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a>`
        }}
        {{ $blowfish := printf `<a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
          href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>`
        }}
        {{ i18n "footer.powered_by" (dict "Hugo" $hugo "Theme" $blowfish) | safeHTML }}
      </p>
    {{ end }}
  </div>
  {{ if not .Site.Params.disableImageZoom | default true }}
    <script>
      mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
        margin: 24,
        background: "rgba(0,0,0,0.5)",
        scrollOffset: 0,
      });
    </script>
  {{ end }}
  {{ $jsProcess := resources.Get "js/process.js" }}
  {{ $jsProcess = $jsProcess | resources.Minify | resources.Fingerprint (.Site.Params.fingerprintAlgorithm | default "sha512") }}
  <script
    type="text/javascript"
    src="{{ $jsProcess.RelPermalink }}"
    integrity="{{ $jsProcess.Data.Integrity }}"></script>
  {{/* Extend footer - eg. for extra scripts, etc. */}}
  {{ if templates.Exists "partials/extend-footer.html" }}
    {{ partialCached "extend-footer.html" . }}
  {{ end }}
<!-- ClustrMaps 容器区域 -->
<!-- 使用 Tailwind 的 Grid 布局，在手机单列，平板/电脑双列 -->
<div class="mx-auto mt-8 grid max-w-4xl grid-cols-1 gap-8 md:grid-cols-2 justify-items-center items-center">

  <!-- 1. 地球仪 (Globe) 容器 -->
  <!-- 强制锁定宽高：w-[300px] 是 Tailwind 写法，强制宽度 300px -->
  <div class="relative flex h-[200px] w-[300px] flex-col items-center justify-center overflow-hidden rounded-lg border border-neutral-200 bg-neutral-50 dark:border-neutral-700 dark:bg-neutral-800">
    <!-- loading 占位符 -->
    <div id="globe-loading" class="absolute text-xs text-neutral-400">Loading Globe...</div>
    <!-- 插件挂载点 -->
    <div id="cm-globe-wrapper" class="z-10 flex h-full w-full items-center justify-center overflow-hidden"></div>
  </div>

  <!-- 2. 平面地图 (Map) 容器 -->
  <div class="relative flex h-[200px] w-[300px] flex-col items-center justify-center overflow-hidden rounded-lg border border-neutral-200 bg-neutral-50 dark:border-neutral-700 dark:bg-neutral-800">
    <div id="map-loading" class="absolute text-xs text-neutral-400">Loading Map...</div>
    <div id="cm-map-wrapper" class="z-10 flex h-full w-full items-center justify-center overflow-hidden"></div>
  </div>

</div>

<!-- 终极修正样式：强制覆盖插件内部样式 -->
<style>
  /* 针对 ClustrMaps 生成的 Canvas 进行降维打击 */
  #cm-globe-wrapper canvas,
  #cm-globe-wrapper img,
  #cm-globe-wrapper div,
  #cm-map-wrapper canvas,
  #cm-map-wrapper img {
    max-width: 100% !important;
    max-height: 100% !important;
    width: auto !important; /* 允许自动缩放，但受 max-width 限制 */
    height: auto !important;
    display: block !important;
    margin: 0 auto !important;
  }
  
  /* 隐藏多余的文字链接，只保留图形 */
  .clustrmaps-control-box a {
    display: block !important;
  }
</style>

<script>
  window.addEventListener('load', function() {
    
    // 封装加载函数
    function loadScript(containerId, src, scriptId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      // 清空容器，移除 loading 文字
      // 注意：这里不清空 container 的父级，只清空 wrapper 内部
      container.innerHTML = '';

      const script = document.createElement('script');
      script.src = src;
      script.id = scriptId;
      script.type = 'text/javascript';
      script.async = true; 
      
      container.appendChild(script);
    }

    // --- 核心逻辑：错峰加载 ---
    
    // 1. 立即加载平面地图 (Map) -因为它比较稳定
    setTimeout(() => {
      const mapLoading = document.getElementById('map-loading');
      if(mapLoading) mapLoading.style.display = 'none';
      
      loadScript(
        'cm-map-wrapper',
        '//clustrmaps.com/map_v2.js?d=jifEa5wkGJle7rCzR78Wj3gsC9ebbUKEwiITXbd3qGA&cl=ffffff&w=a',
        'script-map-v2'
      );
    }, 500); // 页面加载完 0.5秒后加载地图

    // 2. 延迟加载地球仪 (Globe) - 它是“捣乱分子”，最后加载
    setTimeout(() => {
      const globeLoading = document.getElementById('globe-loading');
      if(globeLoading) globeLoading.style.display = 'none';

      loadScript(
        'cm-globe-wrapper',
        '//clustrmaps.com/globe.js?d=jifEa5wkGJle7rCzR78Wj3gsC9ebbUKEwiITXbd3qGA',
        'script-globe'
      );
    }, 2500); // 【关键】推迟 2.5秒！等地图完全渲染完，布局定死后，再让地球仪进场
  });
</script>
</footer>
