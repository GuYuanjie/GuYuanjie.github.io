document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const cards = document.querySelectorAll('.pub-card');
    const visibleCountEl = document.getElementById('visibleCount');
    
    if (!searchInput || cards.length === 0) return;
    
    let activeFilter = 'all';
    let searchQuery = '';
    
    // 搜索功能
    searchInput.addEventListener('input', debounce(function(e) {
        searchQuery = e.target.value.toLowerCase().trim();
        filterPublications();
    }, 300));
    
    // 筛选功能
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            activeFilter = this.dataset.filter;
            filterPublications();
        });
    });
    
    // 综合筛选函数
    function filterPublications() {
        let visibleCount = 0;
        
        cards.forEach(card => {
            const year = card.dataset.year;
            const type = card.dataset.type;
            const tags = card.dataset.tags || '';
            const authors = card.dataset.authors || '';
            const venue = card.dataset.venue || '';
            const title = card.querySelector('.pub-title').textContent.toLowerCase();
            
            // 检查筛选条件
            let matchesFilter = false;
            if (activeFilter === 'all') {
                matchesFilter = true;
            } else if (activeFilter === 'selected') {
                matchesFilter = tags.includes('selected');
            } else if (activeFilter === year || activeFilter === type) {
                matchesFilter = true;
            } else {
                matchesFilter = tags.includes(activeFilter);
            }
            
            // 检查搜索条件
            let matchesSearch = true;
            if (searchQuery) {
                const searchableText = [
                    title,
                    authors,
                    venue,
                    tags,
                    card.querySelector('.pub-authors')?.textContent || '',
                    card.querySelector('.pub-venue')?.textContent || ''
                ].join(' ').toLowerCase();
                
                matchesSearch = searchableText.includes(searchQuery);
            }
            
            // 显示/隐藏卡片
            if (matchesFilter && matchesSearch) {
                card.style.display = 'block';
                card.classList.remove('hidden');
                visibleCount++;
                
                // 添加高亮效果
                if (searchQuery && title.includes(searchQuery)) {
                    card.classList.add('highlight');
                    setTimeout(() => card.classList.remove('highlight'), 1000);
                }
            } else {
                card.style.display = 'none';
                card.classList.add('hidden');
            }
        });
        
        // 更新计数
        if (visibleCountEl) {
            visibleCountEl.textContent = visibleCount;
        }
        
        // 显示空状态
        const listContainer = document.querySelector('.pub-list');
        let noResultsEl = listContainer.querySelector('.no-results');
        
        if (visibleCount === 0) {
            if (!noResultsEl) {
                noResultsEl = document.createElement('div');
                noResultsEl.className = 'no-results';
                noResultsEl.innerHTML = `
                    <i class="fas fa-search"></i>
                    <h3>No publications found</h3>
                    <p>Try adjusting your search or filter</p>
                `;
                listContainer.appendChild(noResultsEl);
            }
        } else if (noResultsEl) {
            noResultsEl.remove();
        }
    }
    
    // 防抖函数
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // 初始化
    filterPublications();
});

// BibTeX 复制功能
function copyBibtex(id) {
    const container = document.getElementById(id);
    if (!container) return;
    
    const code = container.querySelector('.code-content').textContent;
    const feedback = container.querySelector('.copy-feedback');
    
    navigator.clipboard.writeText(code).then(() => {
        feedback.style.display = 'block';
        setTimeout(() => {
            feedback.style.display = 'none';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard. Please select and copy manually.');
    });
}

// 暴露函数到全局
window.copyBibtex = copyBibtex;