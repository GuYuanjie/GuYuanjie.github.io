<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const cards = document.querySelectorAll('.pub-card');
    
    // 安全检查：如果页面上没有这些元素，不执行后续逻辑
    if (!searchInput || cards.length === 0) return;

    let activeFilter = 'all';
    
    // 1. 搜索功能
    searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        filterPublications(activeFilter, query);
    });

    // 2. 标签点击筛选
    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // 移除其他按钮激活状态
            filterBtns.forEach(b => b.classList.remove('active'));
            // 激活当前按钮
            btn.classList.add('active');
            
            activeFilter = btn.getAttribute('data-filter');
            const query = searchInput.value.toLowerCase().trim();
            
            filterPublications(activeFilter, query);
        });
    });

    // 综合筛选函数
    function filterPublications(filter, query) {
        let visibleCount = 0;

        cards.forEach(card => {
            const year = card.getAttribute('data-year');
            const type = card.getAttribute('data-type');
            const tags = card.getAttribute('data-tags') || '';
            // 将搜索内容组合：标题+自定义搜索关键词
            const searchData = (card.getAttribute('data-search') + ' ' + card.innerText).toLowerCase();

            // 检查标签匹配 (支持 year, type, tags)
            let matchesFilter = false;
            if (filter === 'all') matchesFilter = true;
            else if (filter === year) matchesFilter = true;
            else if (filter === type) matchesFilter = true;
            else if (tags.includes(filter)) matchesFilter = true;

            // 检查搜索匹配
            const matchesSearch = query === '' || searchData.includes(query);

            if (matchesFilter && matchesSearch) {
                card.style.display = 'block';
                // 简单的淡入效果
                card.style.opacity = '1'; 
                visibleCount++;
            } else {
                card.style.display = 'none';
                card.style.opacity = '0';
            }
        });
    }
});

// 3. BibTeX 切换显示 (挂载到 window 以便 onclick 调用)
window.toggleBibtex = function(id) {
    const el = document.getElementById(id);
    if (!el) return;

    if (el.classList.contains('show')) {
        el.classList.remove('show');
        setTimeout(() => el.style.display = 'none', 300);
    } else {
        el.style.display = 'block';
        // 延时添加 class 触发 CSS transition
        setTimeout(() => el.classList.add('show'), 10);
    }
}

// 4. BibTeX 复制功能
window.copyBibtex = function(id) {
    const container = document.getElementById(id);
    if (!container) return;
    
    const code = container.querySelector('.code-content').innerText;
    
    navigator.clipboard.writeText(code).then(() => {
        const feedback = container.querySelector('.copy-feedback');
        feedback.style.display = 'block';
        setTimeout(() => {
            feedback.style.display = 'none';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy to clipboard.');
    });
}
</script>